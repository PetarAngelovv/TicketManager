@using TicketManager.Web.ViewModels.Event
@model PaginatedEventsViewModel

@{
    ViewData["Title"] = "Choose Your Adventure";
    Layout = "_Layout";
}

<head>
    <link rel="stylesheet" href="~/css/site.css" />
</head>

<div class="container mt-5">

    <h2 class="mb-4 text-center text-primary">🌍 Explore & Book Your Next Adventure</h2>

    <label class="form-label fw-bold" for="categoryFilter">🧭 Experience Type</label>
    <select id="categoryFilter" class="form-select mb-3">
        <option value="">🌟 All Types</option>
        @foreach (var category in ViewBag.Categories as List<AddCategoryDropDownModel>)
        {
            <option value="@category.Id">🎯 @category.Name</option>
        }
    </select>

    <label for="eventSearchInput" class="form-label fw-bold">🔍 Find Your Dream Escape</label>
    <input type="text" id="eventSearchInput" class="form-control mb-4" placeholder="Search thrilling experiences..." />

    <div id="eventResults">
        @await Html.PartialAsync("EventListPartial", Model)
    </div>

    <div class="text-center mt-4">
        <a asp-controller="Event" asp-action="Favorites" class="btn btn-outline-warning w-100">
            <i class="fas fa-star"></i> ✨ My Saved Adventures
        </a>
    </div>

    <div class="text-center mt-4">
        <form id="deleteRequestForm" method="post">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-dark w-100 mt-2">
                👋 Leave the Journey (Account Deletion)
            </button>
        </form>
        <div id="deleteRequestMessage" class="mt-2 text-success" style="display:none;">
            ✅ Your deletion request has been sent to the admin.
        </div>
    </div>

    <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventDetailsLabel">📖 Adventure Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="eventDetailsContent"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

        $(document).on("click", ".btn-save", function () {
            const button = $(this);
            const eventId = button.data("event-id");

            $.post("/Event/Save", {
                id: eventId,
                __RequestVerificationToken: antiForgeryToken
            })
            .done(function (response) {
                if (response.success) {
                    const card = button.closest(".card");
                    const countSpan = card.find(".favorites-count");
                    countSpan.text(parseInt(countSpan.text()) + 1);

                    button.replaceWith(`
                        <a href="/Event/Favorites" class="btn btn-outline-warning w-100">
                                              <i class="fas fa-star"></i> ✨ Go to Favorites
                        </a>
                    `);
                } else {
                    alert(response.message || "Error saving experience.");
                }
            })
            .fail(() => alert("AJAX error."));
        });

        // Show Details
        $(document).on("click", ".btn-details", function () {
            const eventId = $(this).data("event-id");

            $.get("/Event/GetDetailsPartial", { id: eventId })
                .done(data => {
                    $("#eventDetailsContent").html(data);
                    new bootstrap.Modal(document.getElementById('eventDetailsModal')).show();
                })
                .fail(() => {
                    $("#eventDetailsContent").html("<p class='text-danger'>Error loading adventure details.</p>");
                    new bootstrap.Modal(document.getElementById('eventDetailsModal')).show();
                });
        });

        // Buy Ticket
               $(document).on('click', '.buy-ticket-btn', function () {
            const eventId = $(this).data('event-id');
            const quantity = parseInt($(`#ticketQuantity-${eventId}`).val()) || 1;

            fetch(`/Event/Buy?id=${eventId}&quantity=${quantity}`)
                .then(response => response.json())
                .then(data => {
                         if (data.success) {
            alert(`🎉 You've bought ${quantity} ticket(s)!`);

            const countEl = document.getElementById(`tickets-left-${eventId}`);
            if (countEl) {
                countEl.textContent = `🎟️ Tickets Left: ${data.ticketsLeft}`;
            }

            const quantityInput = $(`#ticketQuantity-${eventId}`);
            const quantityLabel = quantityInput.prev("label");

            if (data.ticketsLeft === 0) {
                quantityInput.remove();
                quantityLabel.remove(); 

                $(this).replaceWith(`
                    <button class="btn btn-sold-out w-100" disabled>
                        🚫 Sold Out
                    </button>
                `);
            } else {
                quantityInput.attr("max", data.ticketsLeft);
            }
        }
         else {
                        alert('❌ ' + data.message);
                    }
                })
                .catch(() => alert("🚨 Something went wrong. Please try again."));
        });


        // Account Deletion Request
        $('#deleteRequestForm').submit(function (e) {
            e.preventDefault();
            if (!confirm("Are you sure you want to leave this adventure?")) return;

            $.post('/User/RequestDelete')
                .done(response => {
                    if (response.success) {
                        $('#deleteRequestMessage').show();
                        $('#deleteRequestForm button').prop('disabled', true).text('Request Sent');
                    } else {
                        alert('❌ ' + response.message);
                    }
                })
                .fail(() => alert('❌ Something went wrong while sending the request.'));
        });

        // Search + Filter + Pagination
        function loadEvents(page = 1) {
            const term = $('#eventSearchInput').val();
            const categoryId = $('#categoryFilter').val();

            $.get('/Event/Search', { term, categoryId, page })
                .done(result => $('#eventResults').html(result))
                .fail(() => $('#eventResults').html('<p class="text-danger">Error loading experiences.</p>'));
        }

        $('#eventSearchInput').on('keyup', () => loadEvents(1));
        $('#categoryFilter').on('change', () => loadEvents(1));

        $(document).on('click', '.page-link-ajax', function (e) {
            e.preventDefault();
            loadEvents($(this).data('page'));
        });

        $(document).ready(() => loadEvents(1));
    </script>
}